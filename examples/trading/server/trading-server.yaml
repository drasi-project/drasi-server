# Copyright 2025 The Drasi Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

server:
  host: 0.0.0.0
  port: 8080
  log_level: info
  disable_persistence: true
server_core:
  id: trading-server
sources:
- kind: http
  id: price-feed
  auto_start: true
  # HttpSourceConfig fields
  host: 0.0.0.0
  port: 9000
  timeout_ms: 10000
- kind: postgres
  id: postgres-stocks
  auto_start: true
  # PostgresSourceConfig fields
  host: localhost
  port: 5432
  database: trading_demo
  user: drasi_user
  password: drasi_password
  tables:
  - stocks
  - portfolio
  slot_name: drasi_trading_slot
  publication_name: drasi_trading_pub
  ssl_mode: prefer
  table_keys:
  - table: stocks
    key_columns:
    - id
  - table: portfolio
    key_columns:
    - id
  bootstrap_provider:
    type: postgres
queries:
- id: watchlist-query
  auto_start: true
  query: |
    MATCH (s:stocks)-[:HAS_PRICE]->(sp:stock_prices)
    WHERE s.symbol IN ['AAPL', 'MSFT', 'GOOGL', 'TSLA', 'NVDA']
    RETURN s.symbol AS symbol,
           s.name AS name,
           sp.price AS price,
           sp.previous_close AS previous_close,
           ((sp.price - sp.previous_close) / sp.previous_close * 100) AS change_percent
  sources:
  - source_id: postgres-stocks
  - source_id: price-feed
  joins:
  - id: HAS_PRICE
    keys:
    - label: stocks
      property: symbol
    - label: stock_prices
      property: symbol
- id: portfolio-query
  auto_start: true
  query: |
    MATCH (p:portfolio)-[:OWNS_STOCK]->(s:stocks)
    OPTIONAL MATCH (s)-[:HAS_PRICE]->(sp:stock_prices)
    RETURN p.symbol AS symbol,
           s.name AS name,
           p.quantity AS quantity,
           p.purchase_price AS purchase_price,
           sp.price AS current_price,
           (sp.price * p.quantity) AS current_value,
           (p.purchase_price * p.quantity) AS cost_basis,
           ((sp.price - p.purchase_price) * p.quantity) AS profit_loss,
           ((sp.price - p.purchase_price) / p.purchase_price * 100) AS profit_loss_percent
  sources:
  - source_id: postgres-stocks
  - source_id: price-feed
  joins:
  - id: OWNS_STOCK
    keys:
    - label: portfolio
      property: symbol
    - label: stocks
      property: symbol
  - id: HAS_PRICE
    keys:
    - label: stocks
      property: symbol
    - label: stock_prices
      property: symbol
- id: top-gainers-query
  auto_start: true
  query: |
    MATCH (s:stocks)-[:HAS_PRICE]->(sp:stock_prices)
    WHERE sp.price > sp.previous_close
    WITH s, sp, ((sp.price - sp.previous_close) / sp.previous_close * 100) AS change_percent
    RETURN s.symbol AS symbol,
           s.name AS name,
           sp.price AS price,
           sp.previous_close AS previous_close,
           change_percent
  sources:
  - source_id: postgres-stocks
  - source_id: price-feed
  joins:
  - id: HAS_PRICE
    keys:
    - label: stocks
      property: symbol
    - label: stock_prices
      property: symbol
- id: top-losers-query
  auto_start: true
  query: |
    MATCH (s:stocks)-[:HAS_PRICE]->(sp:stock_prices)
    WHERE sp.price < sp.previous_close
    WITH s, sp, ((sp.price - sp.previous_close) / sp.previous_close * 100) AS change_percent
    RETURN s.symbol AS symbol,
           s.name AS name,
           sp.price AS price,
           sp.previous_close AS previous_close,
           change_percent
  sources:
  - source_id: postgres-stocks
  - source_id: price-feed
  joins:
  - id: HAS_PRICE
    keys:
    - label: stocks
      property: symbol
    - label: stock_prices
      property: symbol
- id: high-volume-query
  auto_start: true
  query: |
    MATCH (s:stocks)-[:HAS_PRICE]->(sp:stock_prices)
    WHERE sp.volume > 10000000
    RETURN s.symbol AS symbol,
           s.name AS name,
           sp.price AS price,
           sp.volume AS volume,
           ((sp.price - sp.previous_close) / sp.previous_close * 100) AS change_percent
  sources:
  - source_id: postgres-stocks
  - source_id: price-feed
  joins:
  - id: HAS_PRICE
    keys:
    - label: stocks
      property: symbol
    - label: stock_prices
      property: symbol
- id: price-ticker-query
  auto_start: true
  query: |
    MATCH (sp:stock_prices)
    RETURN sp.symbol AS symbol,
           sp.price AS price,
           sp.previous_close AS previous_close,
           ((sp.price - sp.previous_close) / sp.previous_close * 100) AS change_percent
  sources:
  - source_id: price-feed

reactions:
- kind: sse
  id: trading-stream
  auto_start: true
  queries:
  - watchlist-query
  - portfolio-query
  - top-gainers-query
  - top-losers-query
  - high-volume-query
  - price-ticker-query
  host: 0.0.0.0
  port: 50051
  sse_path: /events
  heartbeat_interval_ms: 30000
