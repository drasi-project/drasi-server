# Copyright 2025 The Drasi Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# =============================================================================
# Real-World Scenario: IoT Sensor Alerts
# =============================================================================
#
# This example demonstrates a complete IoT monitoring system:
# - Ingest sensor data via HTTP endpoint
# - Monitor temperature, humidity, and pressure thresholds
# - Generate alerts when values exceed limits
# - Stream alerts to dashboards via SSE
# - Send critical alerts via webhooks
#
# Architecture:
#   Sensors -> HTTP Source -> Queries (threshold detection) -> Reactions
#                                                              |-> Log (debugging)
#                                                              |-> SSE (dashboard)
#                                                              |-> HTTP (alerts)
#
# Run with: cargo run -- --config examples/configs/06-real-world-scenarios/iot-sensor-alerts.yaml
#
# Send sensor data:
#   curl -X POST http://localhost:9000 \
#     -H "Content-Type: application/json" \
#     -d '{"id": "sensor-1", "type": "temperature", "value": 85, "unit": "F"}'

apiVersion: drasi.io/v1
id: iot-sensor-system
host: "0.0.0.0"
port: 8080
logLevel: info
persistConfig: false

sources:
  # HTTP endpoint for sensor data ingestion
  - kind: http
    id: sensor-ingest
    autoStart: true
    host: "0.0.0.0"
    port: 9000
    timeoutMs: 30000

queries:
  # All sensor readings for dashboard
  - id: all-readings
    autoStart: true
    query: |
      MATCH (s:Sensor)
      RETURN s.id AS SensorId,
             s.type AS SensorType,
             s.value AS Value,
             s.unit AS Unit,
             s.location AS Location
    queryLanguage: Cypher
    sources:
      - sourceId: sensor-ingest

  # High temperature alerts (> 80F)
  - id: high-temp-alerts
    autoStart: true
    query: |
      MATCH (s:Sensor)
      WHERE s.type = 'temperature' AND s.value > 80
      RETURN s.id AS SensorId,
             s.value AS Temperature,
             s.location AS Location,
             'HIGH_TEMPERATURE' AS AlertType
    queryLanguage: Cypher
    sources:
      - sourceId: sensor-ingest

  # Low temperature alerts (< 32F - freezing)
  - id: freeze-alerts
    autoStart: true
    query: |
      MATCH (s:Sensor)
      WHERE s.type = 'temperature' AND s.value < 32
      RETURN s.id AS SensorId,
             s.value AS Temperature,
             s.location AS Location,
             'FREEZING' AS AlertType
    queryLanguage: Cypher
    sources:
      - sourceId: sensor-ingest

  # High humidity alerts (> 70%)
  - id: humidity-alerts
    autoStart: true
    query: |
      MATCH (s:Sensor)
      WHERE s.type = 'humidity' AND s.value > 70
      RETURN s.id AS SensorId,
             s.value AS Humidity,
             s.location AS Location,
             'HIGH_HUMIDITY' AS AlertType
    queryLanguage: Cypher
    sources:
      - sourceId: sensor-ingest

  # Sensor statistics
  - id: sensor-stats
    autoStart: true
    query: |
      MATCH (s:Sensor)
      RETURN s.type AS SensorType,
             count(s) AS SensorCount,
             avg(s.value) AS AverageValue,
             min(s.value) AS MinValue,
             max(s.value) AS MaxValue
    queryLanguage: Cypher
    sources:
      - sourceId: sensor-ingest

reactions:
  # Console logging for debugging
  - kind: log
    id: sensor-console
    queries:
      - all-readings
      - high-temp-alerts
      - freeze-alerts
      - humidity-alerts
    autoStart: true
    routes:
      all-readings:
        added:
          template: "[SENSOR] + {{after.SensorId}} ({{after.SensorType}}): {{after.Value}}{{after.Unit}} at {{after.Location}}"
        updated:
          template: "[SENSOR] ~ {{after.SensorId}}: {{after.Value}}{{after.Unit}}"
      high-temp-alerts:
        added:
          template: "[ALERT] HIGH TEMP: Sensor {{after.SensorId}} at {{after.Temperature}}F ({{after.Location}}) - {{after.AlertType}}"
      freeze-alerts:
        added:
          template: "[ALERT] FREEZING: Sensor {{after.SensorId}} at {{after.Temperature}}F ({{after.Location}}) - {{after.AlertType}}"
      humidity-alerts:
        added:
          template: "[ALERT] HIGH HUMIDITY: Sensor {{after.SensorId}} at {{after.Humidity}}% ({{after.Location}}) - {{after.AlertType}}"

  # SSE for real-time dashboard
  - kind: sse
    id: dashboard-stream
    queries:
      - all-readings
      - high-temp-alerts
      - freeze-alerts
      - humidity-alerts
      - sensor-stats
    autoStart: true
    host: "0.0.0.0"
    port: 8081
    ssePath: "/sensors"
    heartbeatIntervalMs: 15000
    routes:
      all-readings:
        added:
          template: '{"type": "reading", "sensorId": "{{after.SensorId}}", "sensorType": "{{after.SensorType}}", "value": {{after.Value}}, "unit": "{{after.Unit}}", "location": "{{after.Location}}"}'
      high-temp-alerts:
        added:
          path: "/alerts"
          template: '{"type": "alert", "severity": "warning", "alertType": "{{after.AlertType}}", "sensorId": "{{after.SensorId}}", "temperature": {{after.Temperature}}, "location": "{{after.Location}}"}'
      freeze-alerts:
        added:
          path: "/alerts"
          template: '{"type": "alert", "severity": "critical", "alertType": "{{after.AlertType}}", "sensorId": "{{after.SensorId}}", "temperature": {{after.Temperature}}, "location": "{{after.Location}}"}'
      humidity-alerts:
        added:
          template: '{"type": "alert", "severity": "warning", "alertType": "{{after.AlertType}}", "sensorId": "{{after.SensorId}}", "humidity": {{after.Humidity}}, "location": "{{after.Location}}"}'
      sensor-stats:
        added:
          template: '{"type": "stats", "sensorType": "{{after.SensorType}}", "count": {{after.SensorCount}}, "avg": {{after.AverageValue}}, "min": {{after.MinValue}}, "max": {{after.MaxValue}}}'
        updated:
          template: '{"type": "stats", "sensorType": "{{after.SensorType}}", "count": {{after.SensorCount}}, "avg": {{after.AverageValue}}, "min": {{after.MinValue}}, "max": {{after.MaxValue}}}'

  # HTTP webhook for critical alerts
  - kind: http
    id: alert-webhook
    queries:
      - freeze-alerts
    autoStart: true
    baseUrl: "${ALERT_WEBHOOK_URL:-http://localhost:3000}"
    timeoutMs: 5000
    routes:
      freeze-alerts:
        added:
          url: "/alerts/critical"
          method: "POST"
          body: '{"alert": "FREEZING_DETECTED", "sensorId": "{{after.SensorId}}", "temperature": {{after.Temperature}}, "location": "{{after.Location}}", "alertType": "{{after.AlertType}}", "priority": "critical"}'
          headers:
            Content-Type: "application/json"
            X-Alert-Priority: "critical"
