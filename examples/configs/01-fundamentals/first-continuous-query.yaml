# Copyright 2025 The Drasi Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# =============================================================================
# First Continuous Query - Understanding Query Configuration
# =============================================================================
#
# This example explains all the options available when configuring queries.
# It demonstrates multiple queries with different configurations.
#
# Key concepts:
# - Continuous queries automatically update when source data changes
# - Queries use Cypher language to define what data to match
# - Bootstrap loads existing data when the query starts
# - Multiple queries can subscribe to the same source
#
# Run with: cargo run -- --config examples/configs/01-fundamentals/first-continuous-query.yaml

id: query-demo-server
host: "0.0.0.0"
port: 8080
logLevel: info
persistConfig: false

sources:
  # Mock source generates data with labels based on dataType:
  #   - "sensor" → SensorReading nodes with temperature, humidity, sensor_id
  #   - "counter" → Counter nodes with count value
  #   - "generic" → Generic nodes with value and message
  - kind: mock
    id: sensor-data
    autoStart: true
    dataType: "sensor"
    intervalMs: 2000

queries:
  # Query 1: Simple match-all query
  - id: all-data
    autoStart: true
    query: |
      MATCH (n)
      RETURN n
    queryLanguage: Cypher
    sources:
      - sourceId: sensor-data
    enableBootstrap: true
    bootstrapBufferSize: 10000

  # Query 2: Filtered query with projection
  - id: high-values
    autoStart: true
    query: |
      MATCH (s:SensorReading)
      WHERE s.temperature > 25
      RETURN s.sensor_id AS SensorId, s.temperature AS Temperature, s.timestamp AS Timestamp
    sources:
      - sourceId: sensor-data
    enableBootstrap: true

  # Query 3: Aggregation query
  - id: value-summary
    autoStart: true
    query: |
      MATCH (s:SensorReading)
      RETURN count(s) AS TotalSensors, avg(s.temperature) AS AverageTemperature
    sources:
      - sourceId: sensor-data

reactions:
  - kind: log
    id: query-results-logger
    queries:
      - all-data
      - high-values
      - value-summary
    autoStart: true
    defaultTemplate:
      added:
        template: "[{{query_name}}] + {{after}}"
      updated:
        template: "[{{query_name}}] ~ {{after}}"
      deleted:
        template: "[{{query_name}}] - {{before}}"
