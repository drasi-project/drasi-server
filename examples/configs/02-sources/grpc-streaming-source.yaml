# Copyright 2025 The Drasi Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# =============================================================================
# gRPC Source - High-Performance Streaming
# =============================================================================
#
# The gRPC source creates a gRPC server that receives streaming data.
# Use this when you need:
# - High-performance, low-latency data ingestion
# - Bi-directional streaming capabilities
# - Strong typing with Protocol Buffers
# - Integration with gRPC-based microservices
#
# Configuration options:
# - host: Address to bind (default: 0.0.0.0)
# - port: Port to listen on (default: 50051)
# - endpoint: Custom endpoint (optional)
# - timeout_ms: Request timeout in milliseconds (default: 5000)
#
# Run with: cargo run -- --config examples/configs/02-sources/grpc-streaming-source.yaml
#
# Connect with a gRPC client to send streaming data to localhost:50051

id: grpc-source-demo
host: "0.0.0.0"
port: 8080
logLevel: info
persistConfig: false

sources:
  # gRPC source for high-performance streaming
  - kind: grpc
    id: grpc-stream
    autoStart: true
    host: "0.0.0.0"
    port: 50051
    timeoutMs: 10000

queries:
  # Track all streaming data
  - id: stream-data
    autoStart: true
    query: |
      MATCH (m:Message)
      RETURN m.id AS MessageId, m.payload AS Payload, m.timestamp AS Timestamp
    sources:
      - sourceId: grpc-stream

  # Aggregate message statistics
  - id: stream-stats
    autoStart: true
    query: |
      MATCH (m:Message)
      RETURN count(m) AS MessageCount
    sources:
      - sourceId: grpc-stream

reactions:
  - kind: log
    id: stream-logger
    queries:
      - stream-data
      - stream-stats
    autoStart: true
    routes:
      stream-data:
        added:
          template: "[gRPC] Message {{after.MessageId}}: {{after.Payload}} ({{after.Timestamp}})"
        updated:
          template: "[gRPC] Message {{after.MessageId}} updated: {{after.Payload}}"
      stream-stats:
        added:
          template: "[gRPC] Stats: {{after.MessageCount}} messages received"
        updated:
          template: "[gRPC] Stats: {{after.MessageCount}} messages total"
