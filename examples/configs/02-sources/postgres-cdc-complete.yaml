# Copyright 2025 The Drasi Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# =============================================================================
# PostgreSQL Source - Complete CDC (Change Data Capture) Example
# =============================================================================
#
# The PostgreSQL source uses logical replication to capture all changes
# to specified tables in real-time. This is the most common source type
# for production systems.
#
# Prerequisites:
# 1. PostgreSQL with logical replication enabled (wal_level = logical)
# 2. A database user with replication permissions
# 3. Tables you want to monitor
#
# Key configuration options:
# - host, port, database, user, password: Connection settings
# - tables: List of tables to monitor for changes
# - slotName: Logical replication slot name (unique per connection)
# - publicationName: Publication name for the tables
# - tableKeys: Primary key configuration per table
# - sslMode: disable, prefer, or require
# - bootstrapProvider: Load existing data on startup
#
# Run with: cargo run -- --config examples/configs/02-sources/postgres-cdc-complete.yaml
#
# SECURITY: Use environment variables for sensitive data in production!

id: postgres-cdc-demo
host: "0.0.0.0"
port: 8080
logLevel: info
persistConfig: false

sources:
  - kind: postgres
    id: app-database
    autoStart: true

    # Connection settings - use env vars in production!
    host: "${POSTGRES_HOST:-localhost}"
    port: 5432
    database: "${POSTGRES_DB:-myapp}"
    user: "${POSTGRES_USER:-drasi_user}"
    password: "${POSTGRES_PASSWORD:-drasi_password}"
    sslMode: prefer

    # Tables to monitor for changes
    tables:
      - users
      - orders
      - products

    # Replication settings (must be unique per source)
    slotName: drasi_cdc_slot
    publicationName: drasi_cdc_publication

    # Primary key configuration for change tracking
    tableKeys:
      - table: users
        keyColumns:
          - id
      - table: orders
        keyColumns:
          - order_id
      - table: products
        keyColumns:
          - sku

    # Bootstrap provider loads existing data on startup
    bootstrapProvider:
      kind: postgres
      host: "${POSTGRES_HOST:-localhost}"
      port: 5432
      database: "${POSTGRES_DB:-myapp}"
      user: "${POSTGRES_USER:-drasi_user}"
      password: "${POSTGRES_PASSWORD:-drasi_password}"
      tables:
        - users
        - orders
        - products
      slotName: drasi_cdc_slot
      publicationName: drasi_cdc_publication
      sslMode: prefer
      tableKeys:
        - table: users
          keyColumns:
            - id
        - table: orders
          keyColumns:
            - order_id
        - table: products
          keyColumns:
            - sku

queries:
  # Track all user changes
  - id: user-changes
    autoStart: true
    query: |
      MATCH (u:users)
      RETURN u.id AS UserId, u.email AS Email, u.created_at AS CreatedAt
    queryLanguage: Cypher
    sources:
      - sourceId: app-database

  # Track orders with total > $100
  - id: high-value-orders
    autoStart: true
    query: |
      MATCH (o:orders)
      WHERE o.total > 100
      RETURN o.order_id AS OrderId, o.customer_id AS CustomerId, o.total AS Total
    queryLanguage: Cypher
    sources:
      - sourceId: app-database

  # Product inventory alerts
  - id: low-inventory
    autoStart: true
    query: |
      MATCH (p:products)
      WHERE p.quantity < 10
      RETURN p.sku AS SKU, p.name AS ProductName, p.quantity AS Quantity
    queryLanguage: Cypher
    sources:
      - sourceId: app-database

reactions:
  - kind: log
    id: cdc-logger
    queries:
      - user-changes
      - high-value-orders
      - low-inventory
    autoStart: true
    routes:
      user-changes:
        added:
          template: "[CDC] + User {{after.UserId}}: {{after.Email}} (created {{after.CreatedAt}})"
        updated:
          template: "[CDC] ~ User {{after.UserId}}: {{after.Email}}"
        deleted:
          template: "[CDC] - User {{before.UserId}} removed"
      high-value-orders:
        added:
          template: "[CDC] + HIGH VALUE Order {{after.OrderId}}: ${{after.Total}} for customer {{after.CustomerId}}"
        updated:
          template: "[CDC] ~ Order {{after.OrderId}}: ${{after.Total}}"
        deleted:
          template: "[CDC] - Order {{before.OrderId}} cancelled"
      low-inventory:
        added:
          template: "[CDC] ⚠ LOW STOCK: {{after.ProductName}} ({{after.SKU}}) only {{after.Quantity}} left"
        updated:
          template: "[CDC] ⚠ STOCK UPDATE: {{after.ProductName}} now {{after.Quantity}} units"
        deleted:
          template: "[CDC] Product {{before.SKU}} removed from inventory"
