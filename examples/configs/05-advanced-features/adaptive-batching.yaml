# Copyright 2025 The Drasi Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# =============================================================================
# Advanced Features - Adaptive Batching
# =============================================================================
#
# Adaptive batching automatically adjusts batch sizes based on throughput
# to optimize performance. Use this when:
# - Processing high-volume event streams
# - Sending to rate-limited APIs
# - Optimizing network efficiency
# - Balancing latency vs throughput
#
# Available for:
# - http-adaptive: HTTP reaction with adaptive batching
# - grpc-adaptive: gRPC reaction with adaptive batching
#
# Adaptive batching parameters:
# - adaptiveMinBatchSize: Minimum batch size (default: 1)
# - adaptiveMaxBatchSize: Maximum batch size (default: 1000)
# - adaptiveWindowSize: Observation window for rate calculation (default: 100)
# - adaptiveBatchTimeoutMs: Max wait before flushing (default: 1000)
#
# Run with: cargo run -- --config examples/configs/05-advanced-features/adaptive-batching.yaml

id: adaptive-batching-demo
host: "0.0.0.0"
port: 8080
logLevel: info
persistConfig: false

sources:
  # High-volume source for testing batching
  - kind: mock
    id: high-volume-stream
    autoStart: true
    dataType: "generic"
    intervalMs: 100

queries:
  - id: all-events
    autoStart: true
    query: |
      MATCH (e:Event)
      RETURN e.id AS EventId, e.type AS Type, e.data AS Data
    queryLanguage: Cypher
    sources:
      - sourceId: high-volume-stream

  - id: event-stats
    autoStart: true
    query: |
      MATCH (e:Event)
      RETURN count(e) AS TotalEvents
    queryLanguage: Cypher
    sources:
      - sourceId: high-volume-stream

reactions:
  # HTTP Adaptive Reaction
  # Batches HTTP requests based on throughput
  - kind: http-adaptive
    id: adaptive-http
    queries:
      - all-events
    autoStart: true

    # Standard HTTP config
    baseUrl: "${WEBHOOK_URL:-http://localhost:3000}"
    timeoutMs: 10000

    # Routes (same as regular HTTP reaction)
    routes:
      all-events:
        added:
          url: "/events/batch"
          method: "POST"
          body: '{"eventId": "{{after.EventId}}", "type": "{{after.Type}}", "data": "{{after.Data}}"}'
          headers:
            Content-Type: "application/json"

    # Adaptive batching configuration
    adaptiveMinBatchSize: 10
    adaptiveMaxBatchSize: 500
    adaptiveWindowSize: 50
    adaptiveBatchTimeoutMs: 2000

  # gRPC Adaptive Reaction
  # Batches gRPC messages based on throughput
  - kind: grpc-adaptive
    id: adaptive-grpc
    queries:
      - all-events
    autoStart: true

    # Standard gRPC config
    endpoint: "${GRPC_ENDPOINT:-grpc://localhost:50052}"
    timeoutMs: 5000
    maxRetries: 3
    connectionRetryAttempts: 5
    initialConnectionTimeoutMs: 10000

    # Adaptive batching configuration
    adaptiveMinBatchSize: 5
    adaptiveMaxBatchSize: 200
    adaptiveWindowSize: 100
    adaptiveBatchTimeoutMs: 1000

  # Log reaction for debugging
  - kind: log
    id: batch-debug
    queries:
      - event-stats
    autoStart: true
    defaultTemplate:
      updated:
        template: "[STATS] Total events processed: {{after.TotalEvents}}"
