# Copyright 2025 The Drasi Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# =============================================================================
# Advanced Features - Persistent Storage
# =============================================================================
#
# DrasiServer supports two types of persistence:
#
# 1. Index Persistence (persistIndex)
#    - Uses RocksDB for persistent query indexes
#    - Survives server restarts
#    - Trades some performance for durability
#    - Default: false (in-memory)
#
# 2. State Store (stateStore)
#    - Persistent storage for plugin state
#    - Sources, bootstrap providers, and reactions can store state
#    - Uses REDB (embedded database)
#    - Useful for checkpointing, deduplication, etc.
#
# When to use each:
# - persistIndex: When you need query state to survive restarts
# - stateStore: When plugins need to persist their internal state
#
# Run with: cargo run -- --config examples/configs/05-advanced-features/persistent-storage.yaml

apiVersion: drasi.io/v1
id: persistent-storage-demo
host: "0.0.0.0"
port: 8080
logLevel: info
persistConfig: true  # Also persist config changes via API

# Enable RocksDB-based index persistence
persistIndex: true

# Configure state store for plugin state persistence
stateStore:
  kind: redb
  path: "${STATE_STORE_PATH:-./data/state.redb}"

sources:
  - kind: mock
    id: persistent-source
    autoStart: true
    dataType:
      type: generic
    intervalMs: 2000

queries:
  # This query's index will be persisted in RocksDB
  - id: persisted-query
    autoStart: true
    query: |
      MATCH (n)
      RETURN n.id AS Id, n.value AS Value
    queryLanguage: Cypher
    sources:
      - sourceId: persistent-source
    enableBootstrap: true
    bootstrapBufferSize: 10000

  # Aggregation that maintains state
  - id: running-totals
    autoStart: true
    query: |
      MATCH (n)
      RETURN count(n) AS TotalRecords, sum(n.value) AS TotalValue
    queryLanguage: Cypher
    sources:
      - sourceId: persistent-source

reactions:
  - kind: log
    id: persistence-demo-log
    queries:
      - persisted-query
      - running-totals
    autoStart: true
    routes:
      persisted-query:
        added:
          template: "[PERSISTENT] persisted-query: + Id={{after.Id}} Value={{after.Value}}"
        updated:
          template: "[PERSISTENT] persisted-query: ~ Id={{after.Id}} Value={{after.Value}}"
      running-totals:
        added:
          template: "[PERSISTENT] running-totals: + Records={{after.TotalRecords}} Sum={{after.TotalValue}}"
        updated:
          template: "[PERSISTENT] running-totals: ~ Records={{after.TotalRecords}} Sum={{after.TotalValue}}"
