# Copyright 2025 The Drasi Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# =============================================================================
# Advanced Features - Read-Only Deployment
# =============================================================================
#
# In production environments, you may want to prevent runtime changes to the
# configuration. DrasiServer supports two related but distinct concepts:
#
# 1. persistConfig: false
#    - API mutations are allowed but NOT saved to the config file
#    - Changes are lost on restart
#    - Useful for ephemeral/dynamic configurations
#
# 2. Read-only config file (file permissions)
#    - API mutations are BLOCKED entirely
#    - Returns 403 Forbidden for create/delete operations
#    - Set by making the config file read-only: chmod 444 config.yaml
#
# This example uses persistConfig: false for a dynamic but non-persistent setup.
# For true read-only, also set file permissions to read-only.
#
# Use cases:
# - GitOps deployments where config comes from version control
# - Immutable infrastructure patterns
# - Security-conscious environments
# - Kubernetes deployments with ConfigMaps
#
# Run with: cargo run -- --config examples/configs/05-advanced-features/read-only-deployment.yaml

id: read-only-demo
host: "0.0.0.0"
port: 8080
logLevel: info

# Disable config persistence - API changes won't be saved
persistConfig: false

# Use in-memory indexes for stateless deployment
persistIndex: false

sources:
  - kind: mock
    id: readonly-source
    autoStart: true
    dataType:
      type: generic
    intervalMs: 2000

queries:
  - id: production-query
    autoStart: true
    query: |
      MATCH (n)
      RETURN n.id AS Id, n.status AS Status
    queryLanguage: Cypher
    sources:
      - sourceId: readonly-source

  - id: monitoring-query
    autoStart: true
    query: |
      MATCH (n)
      RETURN count(n) AS TotalRecords
    queryLanguage: Cypher
    sources:
      - sourceId: readonly-source

reactions:
  - kind: log
    id: production-log
    queries:
      - production-query
      - monitoring-query
    autoStart: true
    routes:
      production-query:
        added:
          template: "[PROD] production-query: + Id={{after.Id}} Status={{after.Status}}"
        updated:
          template: "[PROD] production-query: ~ Id={{after.Id}} Status={{after.Status}}"
      monitoring-query:
        added:
          template: "[PROD] monitoring-query: + Total records={{after.TotalRecords}}"
        updated:
          template: "[PROD] monitoring-query: ~ Total records={{after.TotalRecords}}"

  # SSE for external monitoring
  - kind: sse
    id: monitoring-stream
    queries:
      - monitoring-query
    autoStart: true
    host: "0.0.0.0"
    port: 8081
    ssePath: "/monitoring"
    heartbeatIntervalMs: 30000
