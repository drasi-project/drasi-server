# Copyright 2025 The Drasi Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# =============================================================================
# Query Patterns - Aggregation
# =============================================================================
#
# This example demonstrates aggregation patterns in Cypher:
# - COUNT() - Count matching records
# - SUM() - Sum numeric values
# - AVG() - Calculate averages
# - MIN()/MAX() - Find extremes
# - COLLECT() - Collect values into lists
# - GROUP BY (implicit via non-aggregated columns)
#
# Key concept: Continuous aggregations automatically update when source data changes!
#
# Run with: cargo run -- --config examples/configs/04-query-patterns/aggregation-queries.yaml

id: aggregation-demo
host: "0.0.0.0"
port: 8080
logLevel: info
persistConfig: false

sources:
  - kind: mock
    id: sales-data
    autoStart: true
    dataType: "generic"
    intervalMs: 1500

queries:
  # Simple count
  - id: total-count
    autoStart: true
    query: |
      MATCH (o:Order)
      RETURN count(o) AS TotalOrders
    sources:
      - sourceId: sales-data

  # Sum and average
  - id: revenue-stats
    autoStart: true
    query: |
      MATCH (o:Order)
      RETURN sum(o.amount) AS TotalRevenue,
             avg(o.amount) AS AverageOrder,
             count(o) AS OrderCount
    sources:
      - sourceId: sales-data

  # Min and Max
  - id: price-extremes
    autoStart: true
    query: |
      MATCH (p:Product)
      RETURN min(p.price) AS LowestPrice,
             max(p.price) AS HighestPrice
    sources:
      - sourceId: sales-data

  # Group by with aggregation
  - id: sales-by-category
    autoStart: true
    query: |
      MATCH (o:Order)
      RETURN o.category AS Category,
             count(o) AS OrderCount,
             sum(o.amount) AS CategoryTotal
    sources:
      - sourceId: sales-data

  # Group by with multiple aggregates
  - id: customer-summary
    autoStart: true
    query: |
      MATCH (o:Order)
      RETURN o.customer_id AS CustomerId,
             count(o) AS OrderCount,
             sum(o.amount) AS TotalSpent,
             avg(o.amount) AS AvgOrderValue,
             max(o.amount) AS LargestOrder
    sources:
      - sourceId: sales-data

  # Filtered aggregation
  - id: high-value-stats
    autoStart: true
    query: |
      MATCH (o:Order)
      WHERE o.amount > 100
      RETURN count(o) AS HighValueOrders,
             sum(o.amount) AS HighValueRevenue
    sources:
      - sourceId: sales-data

reactions:
  - kind: log
    id: aggregation-results
    queries:
      - total-count
      - revenue-stats
      - price-extremes
      - sales-by-category
      - customer-summary
      - high-value-stats
    autoStart: true
    defaultTemplate:
      added:
        template: "[{{query_name}}] {{after}}"
      updated:
        template: "[{{query_name}}] {{after}}"
