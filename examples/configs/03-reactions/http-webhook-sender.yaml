# Copyright 2025 The Drasi Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# =============================================================================
# HTTP Reaction - Webhook Sender
# =============================================================================
#
# The HTTP reaction sends query results to external HTTP endpoints.
# Use this for:
# - Triggering webhooks when data changes
# - Integrating with third-party APIs
# - Sending notifications to external services
# - Building event-driven architectures
#
# Configuration options:
# - base_url: Base URL for all requests
# - token: Authentication token (added to Authorization header)
# - timeout_ms: Request timeout in milliseconds
# - routes: Per-query endpoint configuration
#
# Each route can specify:
# - url: Endpoint path (appended to base_url)
# - method: HTTP method (GET, POST, PUT, PATCH, DELETE)
# - body: Request body template (Handlebars)
# - headers: Custom HTTP headers
#
# Run with: cargo run -- --config examples/configs/03-reactions/http-webhook-sender.yaml
#
# SECURITY: Use environment variables for tokens in production!

id: http-webhook-demo
host: "0.0.0.0"
port: 8080
logLevel: info
persistConfig: false

sources:
  - kind: mock
    id: orders
    autoStart: true
    dataType: "generic"
    intervalMs: 3000

queries:
  - id: new-orders
    autoStart: true
    query: |
      MATCH (o:Order)
      RETURN o.id AS OrderId, o.customer AS Customer, o.total AS Total
    sources:
      - sourceId: orders

  - id: high-value-orders
    autoStart: true
    query: |
      MATCH (o:Order)
      WHERE o.total > 500
      RETURN o.id AS OrderId, o.total AS Total
    sources:
      - sourceId: orders

reactions:
  # Log for debugging
  - kind: log
    id: debug-logger
    queries:
      - new-orders
      - high-value-orders
    autoStart: true

  # HTTP webhook reaction
  - kind: http
    id: order-webhooks
    queries:
      - new-orders
      - high-value-orders
    autoStart: true

    # Base configuration
    baseUrl: "${WEBHOOK_BASE_URL:-http://localhost:3000}"
    token: "${WEBHOOK_TOKEN}"
    timeoutMs: 10000

    # Per-query routes
    routes:
      new-orders:
        added:
          url: "/webhooks/orders/created"
          method: "POST"
          body: '{"event": "order.created", "data": {{after}}}'
          headers:
            Content-Type: "application/json"
            X-Event-Type: "order.created"
        updated:
          url: "/webhooks/orders/updated"
          method: "POST"
          body: '{"event": "order.updated", "before": {{before}}, "after": {{after}}}'
          headers:
            Content-Type: "application/json"
        deleted:
          url: "/webhooks/orders/cancelled"
          method: "POST"
          body: '{"event": "order.cancelled", "data": {{before}}}'
          headers:
            Content-Type: "application/json"

      high-value-orders:
        added:
          url: "/webhooks/alerts/high-value"
          method: "POST"
          body: '{"alert": "high_value_order", "order": {{after}}}'
          headers:
            Content-Type: "application/json"
            X-Priority: "high"
