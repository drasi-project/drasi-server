# Copyright 2025 The Drasi Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# =============================================================================
# gRPC Reaction - High-Performance Streaming Response
# =============================================================================
#
# The gRPC reaction streams query results to gRPC clients.
# Use this for:
# - Microservices integration
# - High-performance, low-latency notifications
# - Strong typing with Protocol Buffers
# - Bi-directional streaming architectures
#
# Configuration options:
# - endpoint: gRPC endpoint URL (default: grpc://localhost:50052)
# - timeoutMs: Request timeout (default: 5000)
# - batchSize: Number of events per batch (default: 100)
# - batchFlushTimeoutMs: Max wait before flushing batch (default: 1000)
# - maxRetries: Retry attempts for failed sends (default: 3)
# - connectionRetryAttempts: Connection retry attempts (default: 5)
# - initialConnectionTimeoutMs: Initial connection timeout (default: 10000)
# - metadata: Custom gRPC metadata headers
#
# Run with: cargo run -- --config examples/configs/03-reactions/grpc-streaming-reaction.yaml

apiVersion: drasi.io/v1
id: grpc-reaction-demo
host: "0.0.0.0"
port: 8080
logLevel: info
persistConfig: false

sources:
  - kind: mock
    id: events
    autoStart: true
    dataType:
      type: generic
    intervalMs: 500

queries:
  - id: all-events
    autoStart: true
    query: |
      MATCH (e:Event)
      RETURN e.id AS EventId, e.type AS Type, e.payload AS Payload
    queryLanguage: Cypher
    sources:
      - sourceId: events

  - id: critical-events
    autoStart: true
    query: |
      MATCH (e:Event)
      WHERE e.priority = 'critical'
      RETURN e.id AS EventId, e.message AS Message
    queryLanguage: Cypher
    sources:
      - sourceId: events

reactions:
  # Log for debugging
  - kind: log
    id: debug-log
    queries:
      - all-events
      - critical-events
    autoStart: true

  # gRPC reaction for streaming to services
  - kind: grpc
    id: grpc-stream
    queries:
      - all-events
      - critical-events
    autoStart: true

    # gRPC endpoint configuration
    endpoint: "${GRPC_ENDPOINT:-grpc://localhost:50052}"
    timeoutMs: 10000

    # Batching configuration for efficiency
    batchSize: 50
    batchFlushTimeoutMs: 500

    # Retry configuration
    maxRetries: 5
    connectionRetryAttempts: 10
    initialConnectionTimeoutMs: 15000

    # Custom metadata headers
    metadata:
      x-service-name: "drasi-server"
      x-environment: "${ENVIRONMENT:-development}"
