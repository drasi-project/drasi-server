# Example DrasiServer configuration with identity providers
#
# This configuration demonstrates how to define and use identity providers
# for authentication with external systems like databases.

# Server identification and settings
id: "drasi-server-with-auth"
host: "0.0.0.0"
port: 8080
logLevel: "info"
persistConfig: true
persistIndex: false

# Define reusable identity providers
identityProviders:
  # Password-based authentication (traditional username/password)
  - kind: password
    id: local-postgres
    username: myuser
    password: ${POSTGRES_PASSWORD:-secret}

  # Password-based authentication with environment variables
  - kind: password
    id: staging-db
    username: ${DB_USER:-staging_user}
    password: ${DB_PASSWORD}

  # Password-based authentication for different database
  - kind: password
    id: analytics-db
    username: analytics_user
    password: ${ANALYTICS_PASSWORD:-analytics_secret}

  # Azure AD authentication with Workload Identity (recommended for AKS)
  - kind: azure
    id: azure-postgres
    username: myapp@tenant.onmicrosoft.com
    authenticationMode: workloadIdentity
    scope: https://ossrdbms-aad.database.windows.net/.default

  # Azure AD with Managed Identity (user-assigned)
  - kind: azure
    id: azure-managed
    username: myapp@tenant.onmicrosoft.com
    authenticationMode: managedIdentity
    clientId: ${AZURE_CLIENT_ID}

  # AWS IAM authentication for RDS
  - kind: aws
    id: aws-rds
    username: iamuser
    hostname: mydb.us-east-1.rds.amazonaws.com
    port: 5432
    region: us-east-1
    authenticationMode: defaultCredentials

  # AWS IAM with role assumption
  - kind: aws
    id: aws-rds-role
    username: iamuser
    hostname: mydb.us-east-1.rds.amazonaws.com
    port: 5432
    region: us-east-1
    authenticationMode: assumeRole
    roleArn: arn:aws:iam::123456789012:role/DrasiDatabaseRole
    sessionName: drasi-session

# Sources
sources:
  # Mock source for testing
  - kind: mock
    id: test-source
    autoStart: true
    dataType: sensor
    intervalMs: 1000

  # PostgreSQL source with password authentication
  # Note: In the future, sources will be able to reference identity providers
  # For now, identity providers are defined separately for potential use by reactions
  - kind: postgres
    id: local-db
    host: localhost
    port: 5432
    database: testdb
    user: myuser
    password: ${POSTGRES_PASSWORD:-secret}
    slotName: drasi_slot
    publicationName: drasi_pub
    autoStart: true

# Queries
queries:
  - id: high-temp
    query: "MATCH (s:Sensor) WHERE s.temperature > 75 RETURN s"
    queryLanguage: Cypher
    sources:
      - sourceId: test-source
    autoStart: true

# Reactions
reactions:
  # Log reaction for console output
  - kind: log
    id: log-temps
    queries:
      - high-temp
    autoStart: true

  # Note: HTTP and other reactions can also be configured to use identity providers
  # for authentication when making outbound requests (future enhancement)
